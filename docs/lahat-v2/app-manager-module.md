# App Manager Module

## Overview

The App Manager module is responsible for loading, displaying, and managing the web components generated by the App Creator. It provides a container environment where these components can run safely and communicate with each other through a controlled event system.

## Features

- Loading and displaying generated web components
- Managing the lifecycle of components
- Providing a secure execution environment
- Facilitating communication between components
- Widget management and organization

## Architecture

The App Manager module is implemented as a view that is displayed when a user selects an app from the App List. It consists of several key components:

### Components

```
┌─────────────────────────────────────────────┐
│               App Manager                   │
│                                             │
│  ┌─────────────────────────────────────────┐│
│  │              EventBus                   ││
│  └─────────────────────────────────────────┘│
│                                             │
│  ┌─────────────────────────────────────────┐│
│  │             LahatApp                    ││
│  │                                         ││
│  │  ┌───────────────┐  ┌───────────────┐   ││
│  │  │  LahatCell 1  │  │  LahatCell 2  │   ││
│  │  │               │  │               │   ││
│  │  │ ┌───────────┐ │  │ ┌───────────┐ │   ││
│  │  │ │CustomEvent│ │  │ │CustomEvent│ │   ││
│  │  │ └───────────┘ │  │ └───────────┘ │   ││
│  │  │               │  │               │   ││
│  │  │ ┌───────────┐ │  │ ┌───────────┐ │   ││
│  │  │ │ WebComp   │ │  │ │ WebComp   │ │   ││
│  │  │ └───────────┘ │  │ └───────────┘ │   ││
│  │  └───────────────┘  └───────────────┘   ││
│  │                                         ││
│  └─────────────────────────────────────────┘│
│                                             │
│  ┌─────────────────────────────────────────┐│
│  │            Widget Drawer                ││
│  │                                         ││
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐    ││
│  │  │Widget 1 │ │Widget 2 │ │Widget 3 │ +  ││
│  │  └─────────┘ └─────────┘ └─────────┘    ││
│  └─────────────────────────────────────────┘│
│                                             │
└─────────────────────────────────────────────┘
```

### LahatApp

The LahatApp is the main container component that manages the layout and lifecycle of LahatCells. It is responsible for:

- Creating and destroying LahatCells
- Managing the layout of cells (tiling, resizing, etc.)
- Routing events between cells through the EventBus

### LahatCell

LahatCells are container components that host the generated web components. Each LahatCell:

- Provides a secure sandbox for the contained component
- Manages the lifecycle of the component (creation, initialization, destruction)
- Contains a CustomEvent handler that acts as an event proxy
- Communicates with other cells through the EventBus

### Module-Specific EventBus

The App Manager module has its own internal EventBus that allows components within the module to communicate without direct dependencies. It:

- Implements a publish-subscribe pattern
- Routes events between components within the App Manager module
- Provides security by controlling which events can be sent and received
- Is completely independent from other modules' event systems

### Widget Drawer

The Widget Drawer displays available widgets that can be added to the current app. It:

- Shows a list of available widgets
- Allows users to add widgets to the app
- Provides a "+" button to create new widgets through the App Creator

## User Interactions

1. **Viewing an App**: When a user selects an app from the App List, it is loaded in the App Manager
2. **Interacting with Widgets**: Users can interact with the widgets displayed in LahatCells
3. **Adding Widgets**: Users can add widgets from the Widget Drawer to the app
4. **Creating New Widgets**: Users can create new widgets by clicking the "+" button in the Widget Drawer

## Implementation Details

### Directory Structure

```
src/
└── app-manager/
    ├── components/
    │   ├── lahat-app.js
    │   ├── lahat-cell.js
    │   ├── event-bus.js
    │   ├── custom-event-proxy.js
    │   └── widget-drawer.js
    ├── services/
    │   ├── component-loader.js
    │   └── layout-manager.js
    ├── utils/
    │   ├── event-utils.js
    │   └── security-utils.js
    ├── app-manager.html
    └── app-manager.js
```

### Key Classes

- **LahatApp**: Main container for the app
- **LahatCell**: Container for individual web components
- **EventBus**: Central communication mechanism
- **CustomEventProxy**: Handles event proxying between components
- **WidgetDrawer**: Displays available widgets
- **ComponentLoader**: Loads web components into LahatCells
- **LayoutManager**: Manages the layout of LahatCells

## Communication Architecture

The App Manager module has two distinct communication layers:

1. **Inter-Module Communication**:
   - Uses Electron's contextBridge for IPC between modules
   - Communicates with the main process and other renderer processes

2. **Intra-Module Communication**:
   - Uses the EventBus for communication between components within the module
   - Facilitates communication between LahatCells and their contained web components

### Events

The App Manager module publishes the following events:
- `app-loaded`: When an app is successfully loaded
- `widget-added`: When a widget is added to the app
- `widget-removed`: When a widget is removed from the app
- `create-widget-requested`: When a user clicks the "+" button in the Widget Drawer

The App Manager module subscribes to the following events:
- `app-selected`: When a user selects an app from the App List
- `widget-created`: When a new widget is created by the App Creator

## Security Considerations

- LahatCells provide a secure sandbox for running web components
- The EventBus controls which events can be sent and received
- Web components are loaded with strict Content Security Policy (CSP) settings
- Event proxies ensure that only permitted events are propagated
